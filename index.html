<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NZ Autumn Trip 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, query, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        window.fb = { initializeApp, getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, query, writeBatch, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken };
    </script>
    <style>
        [v-cloak] { display: none; }
        .app-container { max-width: 500px; margin: 0 auto; min-height: 100vh; background: #0f172a; color: #f1f5f9; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); }
        .nav-blur { backdrop-filter: blur(20px); background: rgba(15, 23, 42, 0.8); }
        .safe-bottom { padding-bottom: calc(env(safe-area-inset-bottom) + 120px); }
        .accent-gradient { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .green-gradient { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    </style>
</head>
<body>

<div id="app" v-cloak class="app-container font-sans flex flex-col relative overflow-x-hidden">
    <!-- Header -->
    <header class="sticky top-0 z-50 p-5 nav-blur border-b border-slate-800 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-black tracking-tighter text-white">NZ GOLDEN 2026</h1>
            <div class="flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-orange-500 animate-pulse"></span>
                <p class="text-[10px] text-orange-400 font-bold uppercase tracking-widest">è¡Œç¨‹ç®¡ç†ç³»çµ±</p>
            </div>
        </div>
        <button v-if="itinerary.length === 0" @click="importDefaults" class="text-[10px] bg-orange-600/20 text-orange-400 px-3 py-1.5 rounded-full border border-orange-500/30 font-bold">åŒ¯å…¥è¡Œç¨‹</button>
    </header>

    <!-- Main Content -->
    <main class="flex-grow p-6 safe-bottom">
        
        <!-- Tab 1: è¡Œç¨‹ (Itinerary) -->
        <section v-if="activeTab === 'itinerary'" class="space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-black text-white">è¡Œç¨‹è¦åŠƒ</h2>
                <button @click="openItineraryModal()" class="accent-gradient w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg shadow-orange-900/40 active:scale-95 transition">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"/></svg>
                </button>
            </div>

            <div v-if="loading" class="text-center py-20">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-orange-500"></div>
                <p class="mt-4 text-slate-500">è³‡æ–™åŒæ­¥ä¸­...</p>
            </div>

            <div v-if="!loading && itinerary.length === 0" class="text-center py-20 border-2 border-dashed border-slate-800 rounded-[2.5rem]">
                <p class="text-slate-500 text-sm mb-4">å°šæœªæœ‰è¡Œç¨‹è³‡æ–™</p>
                <button @click="importDefaults" class="accent-gradient text-white px-8 py-3 rounded-full font-bold shadow-xl">åŒ¯å…¥ 2026 å®Œæ•´è¦åŠƒ</button>
            </div>

            <div v-for="(items, day) in groupedItinerary" :key="day" class="space-y-4">
                <div class="flex items-center gap-3 py-2 sticky top-20 z-10 bg-slate-900/90 backdrop-blur-sm">
                    <span class="bg-orange-600 text-white text-[10px] font-black px-3 py-1 rounded-lg">Day {{ day }}</span>
                    <span class="text-xs font-bold text-slate-400">{{ items[0].date }}</span>
                    <div class="h-px flex-grow bg-slate-800"></div>
                </div>

                <div v-for="item in items" :key="item.id" class="glass rounded-3xl p-5 border border-slate-700/50">
                    <div class="flex gap-4">
                        <div class="flex flex-col items-center min-w-[50px]">
                            <span class="text-xs font-black text-orange-400">{{ item.time }}</span>
                            <div class="w-px h-full bg-slate-800 my-2"></div>
                            <button @click="toggleItineraryDone(item)" :class="item.done ? 'bg-orange-600 border-orange-600' : 'border-slate-700 bg-slate-800'" class="w-6 h-6 rounded-full border flex items-center justify-center transition-colors">
                                <svg v-if="item.done" class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>
                            </button>
                        </div>
                        <div class="flex-grow">
                            <h3 :class="{'line-through opacity-40 text-slate-500': item.done}" class="font-bold text-white text-lg leading-tight">{{ item.location }}</h3>
                            <p class="text-sm text-slate-300 mt-1 font-medium">{{ item.activity }}</p>
                            <p v-if="item.details" class="text-xs text-slate-500 mt-2 bg-slate-950/40 p-3 rounded-xl border border-slate-800">{{ item.details }}</p>
                            <div v-if="item.accommodation" class="mt-3 flex items-center gap-2 text-[10px] text-emerald-400 font-bold uppercase">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="2 2 20 20"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                                ä½å®¿ï¼š{{ item.accommodation }}
                            </div>
                            <div class="mt-4 flex gap-4 border-t border-slate-800/50 pt-3">
                                <button @click="openItineraryModal(item)" class="text-[10px] font-bold text-slate-500 hover:text-orange-400">ç·¨è¼¯</button>
                                <button @click="deleteItineraryItem(item.id)" class="text-[10px] font-bold text-red-900/50 hover:text-red-500">åˆªé™¤</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tab 2: åˆ†å¸³ (Expenses) -->
        <section v-if="activeTab === 'expenses'" class="space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-black text-white">å…±åŒæ”¯å‡º</h2>
                <button @click="openExpenseModal()" class="green-gradient w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg shadow-emerald-900/40 active:scale-95 transition">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                </button>
            </div>

            <!-- Settle Card -->
            <div class="glass rounded-[2.5rem] p-7 border-2 border-emerald-500/20 bg-gradient-to-br from-emerald-500/10 to-transparent">
                <p class="text-[10px] font-bold text-emerald-400 uppercase tracking-widest mb-1">ç¸½èŠ±è²» (NZD)</p>
                <div class="text-4xl font-black text-white">${{ totalExpense.toFixed(2) }}</div>
                
                <div class="mt-6 pt-6 border-t border-slate-800 space-y-4">
                    <div v-for="(balance, person) in settleBalances" :key="person" class="flex justify-between items-center">
                        <span class="text-sm font-bold text-slate-300">{{ person }}</span>
                        <div class="text-right">
                            <p :class="balance >= 0 ? 'text-emerald-400' : 'text-red-400'" class="font-mono font-black text-sm">
                                {{ balance >= 0 ? 'æ‡‰æ”¶' : 'æ‡‰ä»˜' }} ${{ Math.abs(balance).toFixed(2) }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expense List -->
            <div class="space-y-3">
                <div v-for="exp in expenses" :key="exp.id" class="glass rounded-3xl p-5 flex justify-between items-center border border-slate-700/30">
                    <div>
                        <h4 class="font-bold text-white">{{ exp.title }}</h4>
                        <p class="text-[10px] text-slate-500">ä»˜æ¬¾äººï¼š<span class="text-slate-300">{{ exp.payer }}</span></p>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-black text-white">${{ exp.amount }}</p>
                        <button @click="deleteExpenseItem(exp.id)" class="text-[10px] text-red-500/40 font-bold uppercase">åˆªé™¤</button>
                    </div>
                </div>
                <div v-if="expenses.length === 0" class="text-center py-10 text-slate-600 text-sm">æš«ç„¡æ”¯å‡ºè¨˜éŒ„</div>
            </div>
        </section>
    </main>

    <!-- Navigation -->
    <nav class="fixed bottom-8 left-1/2 -translate-x-1/2 w-[90%] max-w-[400px] h-20 glass nav-blur rounded-full flex items-center justify-around px-2 z-[60] border border-slate-700/50 shadow-2xl">
        <button @click="activeTab = 'itinerary'" :class="activeTab === 'itinerary' ? 'text-orange-500 bg-orange-500/10' : 'text-slate-500'" class="flex-1 flex flex-col items-center gap-1 py-3 rounded-full transition-all">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/></svg>
            <span class="text-[10px] font-black uppercase">è¡Œç¨‹</span>
        </button>
        <button @click="activeTab = 'expenses'" :class="activeTab === 'expenses' ? 'text-emerald-500 bg-emerald-500/10' : 'text-slate-500'" class="flex-1 flex flex-col items-center gap-1 py-3 rounded-full transition-all">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/></svg>
            <span class="text-[10px] font-black uppercase">åˆ†å¸³</span>
        </button>
    </nav>

    <!-- Itinerary Modal -->
    <div v-if="modals.itinerary.show" class="fixed inset-0 z-[100] flex items-end sm:items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
        <div class="bg-slate-900 w-full max-w-sm rounded-[3rem] p-8 border border-slate-700 shadow-2xl space-y-5">
            <h3 class="text-xl font-black text-white">{{ modals.itinerary.editId ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¨ˆç•«' }}</h3>
            <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase">ç¬¬å¹¾å¤© (Day)</label>
                        <input type="number" v-model="modals.itinerary.form.day" class="w-full bg-slate-800 rounded-2xl p-4 text-white font-bold outline-none border border-slate-700">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase">æ™‚é–“</label>
                        <input type="text" v-model="modals.itinerary.form.time" placeholder="09:00" class="w-full bg-slate-800 rounded-2xl p-4 text-white font-bold outline-none border border-slate-700">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase">åœ°é»</label>
                    <input type="text" v-model="modals.itinerary.form.location" class="w-full bg-slate-800 rounded-2xl p-4 text-white font-bold outline-none border border-slate-700">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase">æ´»å‹•æ‘˜è¦</label>
                    <input type="text" v-model="modals.itinerary.form.activity" class="w-full bg-slate-800 rounded-2xl p-4 text-white font-bold outline-none border border-slate-700">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase">ä½å®¿</label>
                    <input type="text" v-model="modals.itinerary.form.accommodation" class="w-full bg-slate-800 rounded-2xl p-4 text-white font-bold outline-none border border-slate-700">
                </div>
            </div>
            <div class="flex gap-4">
                <button @click="modals.itinerary.show = false" class="flex-1 py-4 text-slate-500 font-bold">å–æ¶ˆ</button>
                <button @click="saveItinerary" class="flex-[2] accent-gradient text-white py-4 rounded-2xl font-black shadow-lg">å„²å­˜ä¸¦æ›´æ–°</button>
            </div>
        </div>
    </div>

    <!-- Expense Modal -->
    <div v-if="modals.expense.show" class="fixed inset-0 z-[100] flex items-end sm:items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
        <div class="bg-slate-900 w-full max-w-sm rounded-[3rem] p-8 border border-slate-700 shadow-2xl space-y-5">
            <h3 class="text-xl font-black text-white">æ–°å¢æ”¯å‡º</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase">é …ç›®åç¨±</label>
                    <input type="text" v-model="modals.expense.form.title" placeholder="å¦‚ï¼šç§Ÿè»Šã€æ™šé¤" class="w-full bg-slate-800 rounded-2xl p-4 text-white font-bold outline-none border border-slate-700">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase">é‡‘é¡ (NZD)</label>
                    <input type="number" v-model="modals.expense.form.amount" class="w-full bg-slate-800 rounded-2xl p-4 text-white font-bold outline-none border border-slate-700">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase">èª°ä»˜çš„ï¼Ÿ</label>
                    <select v-model="modals.expense.form.payer" class="w-full bg-slate-800 rounded-2xl p-4 text-white font-bold outline-none border border-slate-700">
                        <option v-for="p in people" :key="p" :value="p">{{ p }}</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-4">
                <button @click="modals.expense.show = false" class="flex-1 py-4 text-slate-500 font-bold">å–æ¶ˆ</button>
                <button @click="saveExpense" class="flex-[2] green-gradient text-white py-4 rounded-2xl font-black shadow-lg">è¨˜éŒ„æ”¯å‡º</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
const { createApp, ref, computed, onMounted } = Vue;

createApp({
    setup() {
        const userId = ref(null);
        const loading = ref(true);
        const activeTab = ref('itinerary');
        const itinerary = ref([]);
        const expenses = ref([]);
        const people = ref(['æˆ‘', 'å¤¥ä¼´A', 'å¤¥ä¼´B']);

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'nz-golden-2026-v2';
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = fb.initializeApp(firebaseConfig);
        const auth = fb.getAuth(app);
        const db = fb.getFirestore(app);

        const getItineraryColl = () => fb.collection(db, 'artifacts', appId, 'public', 'data', 'itinerary');
        const getExpenseColl = () => fb.collection(db, 'artifacts', appId, 'public', 'data', 'expenses');

        const modals = ref({
            itinerary: { show: false, editId: null, form: { day: 1, date: '', time: '', location: '', activity: '', accommodation: '', details: '', done: false } },
            expense: { show: false, form: { title: '', amount: 0, payer: 'æˆ‘', participants: ['æˆ‘', 'å¤¥ä¼´A', 'å¤¥ä¼´B'] } }
        });

        const defaultPlan = [
            { day: 1, date: '4/23 (å››)', time: '18:40', location: 'å°åŒ— TPE ï¼ é¦™æ¸¯ HKG', activity: 'æ­æ©Ÿ1 (TPE-HKG)', details: '20:40 æŠµé” / è½‰æ©Ÿ 55 åˆ†é˜', done: false },
            { day: 1, date: '4/23 (å››)', time: '21:35', location: 'é¦™æ¸¯åœ‹éš›æ©Ÿå ´', activity: 'æ­æ©Ÿ2 (HKG-SYD)', details: '9å°æ™‚èˆªç¨‹', done: false },
            { day: 2, date: '4/24 (äº”)', time: '08:40', location: 'é›ªæ¢¨ Sydney', activity: 'æŠµé”æ¾³æ´²é›ªæ¢¨', accommodation: 'æ¹–æ™¯å°æœ¨å±‹å…¬å¯“(3N)', details: '1000-1400 é›ªæ¢¨è§€å…‰ï¼šå¤§æ©‹ã€æ­ŒåŠ‡é™¢ã€ç’°å½¢ç¢¼é ­', done: false },
            { day: 2, date: '4/24 (äº”)', time: '16:15', location: 'é›ªæ¢¨ Airport', activity: 'æ­æ©Ÿ3 (SYD-ZQN)', details: '21:15 æŠµé”çš‡åé®ã€‚ğŸšŒ15minæ©Ÿå ´ï¼å¸‚ä¸­å¿ƒ', done: false },
            { day: 3, date: '4/25 (å…­)', time: 'ä¸Šåˆ', location: 'çš‡åé® Queenstown', activity: 'è·³å‚˜ / å‰µæ„æ‰‹å·¥å¸‚é›†', accommodation: 'æ¹–æ™¯å°æœ¨å±‹å…¬å¯“(3N)', details: 'è·³å‚˜å®˜ç¶²ï¼šNZONE Skydive', done: false },
            { day: 3, date: '4/25 (å…­)', time: 'ä¸‹åˆ', location: 'Skyline', activity: 'Skyline çºœè»Š + Luge æ»‘è»Š', done: false },
            { day: 4, date: '4/26 (æ—¥)', time: '09:00', location: 'æ ¼æ—è«¾å¥‡ Glenorchy', activity: 'High Country é¨é¦¬æ¸¡æ²³', accommodation: 'æ¹–æ™¯å°æœ¨å±‹å…¬å¯“(3N)', details: 'é­”æˆ’æ™¯é»ã€‚å›ç¨‹å»é¹¿åœ’ Deer Park Heights', done: false },
            { day: 5, date: '4/27 (ä¸€)', time: 'å…¨å¤©', location: 'ç®­é® / ç“¦ç´å¡', activity: 'ç®­é®é‡‘ç§‹æ•£ç­–ã€Cromwell æ°´æœåº—', accommodation: 'Wanaka éœ²ç‡Ÿè»Š', details: 'Ayrburn é…’å» ã€æœ€å­¤ç¨çš„æ¨¹', done: false },
            { day: 6, date: '4/28 (äºŒ)', time: 'ä¸Šåˆ', location: 'ç“¦ç´å¡ Wanaka', activity: 'Roys Peak å¥è¡Œ', details: 'è·¯ç¨‹é¢¨æ™¯éå¸¸ç¾', done: false },
            { day: 6, date: '4/28 (äºŒ)', time: 'ä¸‹åˆ', location: 'åº«å…‹å±± / æ™®å¡åŸºæ¹–', activity: 'å†°æ²³åŠæ©‹å¥è¡Œ', accommodation: 'åº«å…‹å±±éœ²ç‡Ÿè»Š', done: false },
            { day: 7, date: '4/29 (ä¸‰)', time: 'ä¸Šåˆ', location: 'åº«å…‹å±± Mt. Cook', activity: 'Hooker Valley Track å¥è¡Œ', details: 'éœ€è¿½è¹¤åŠæ©‹é–‹æ”¾é€²åº¦', done: false },
            { day: 7, date: '4/29 (ä¸‰)', time: 'å‚æ™š', location: 'è’‚å¡æ³¢æ¹– Tekapo', activity: 'Tekapo è§€æ˜Ÿ', accommodation: 'Tekapo éœ²ç‡Ÿè»Š', done: false },
            { day: 8, date: '4/30 (å››)', time: 'å…¨å¤©', location: 'Tekapo / å·¨çŸ³é™£', activity: 'ç‰§ç¾Šäººæ•™å ‚ã€å¤©ç„¶å²©çŸ³è¿·å®®', details: 'ç´å°¼äºå‚³å¥‡å–æ™¯åœ°', done: false },
            { day: 9, date: '5/01 (äº”)', time: 'å…¨å¤©', location: 'åŸºç£åŸ Christchurch', activity: 'é›…èŠ³æ²³æ’ç¯™ã€é‚„è»Š', accommodation: 'åŸºç£åŸæ°‘å®¿', done: false },
            { day: 10, date: '5/02 (å…­)', time: '13:00', location: 'åŸºç£åŸæ©Ÿå ´', activity: 'è¿”ç¨‹', details: 'å»ºè­° 13:30 æŠµé”æ©Ÿå ´', done: false }
        ];

        onMounted(async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await fb.signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await fb.signInAnonymously(auth);
            }
            fb.onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId.value = user.uid;
                    sync();
                }
            });
        });

        const sync = () => {
            fb.onSnapshot(getItineraryColl(), snap => {
                itinerary.value = snap.docs.map(d => ({ id: d.id, ...d.data() }))
                    .sort((a,b) => a.day - b.day || (a.time || '').localeCompare(b.time || ''));
                loading.value = false;
            });
            fb.onSnapshot(getExpenseColl(), snap => {
                expenses.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            });
        };

        const importDefaults = async () => {
            if(!userId.value) return;
            loading.value = true;
            try {
                const batch = fb.writeBatch(db);
                defaultPlan.forEach(p => {
                    const ref = fb.doc(getItineraryColl());
                    batch.set(ref, p);
                });
                await batch.commit();
            } catch(e) { console.error(e); }
            loading.value = false;
        };

        const openItineraryModal = (item = null) => {
            modals.value.itinerary.editId = item?.id || null;
            modals.value.itinerary.form = item ? { ...item } : { day: 1, time: '', location: '', activity: '', accommodation: '', details: '', done: false };
            modals.value.itinerary.show = true;
        };

        const saveItinerary = async () => {
            if(!userId.value) return;
            const id = modals.value.itinerary.editId || crypto.randomUUID();
            await fb.setDoc(fb.doc(getItineraryColl(), id), { ...modals.value.itinerary.form });
            modals.value.itinerary.show = false;
        };

        const deleteItineraryItem = async id => { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) await fb.deleteDoc(fb.doc(getItineraryColl(), id)); };
        const toggleItineraryDone = async item => await fb.setDoc(fb.doc(getItineraryColl(), item.id), { done: !item.done }, { merge: true });

        const groupedItinerary = computed(() => {
            const groups = {};
            itinerary.value.forEach(i => {
                if (!groups[i.day]) groups[i.day] = [];
                groups[i.day].push(i);
            });
            return groups;
        });

        // Expenses logic
        const openExpenseModal = () => {
            modals.value.expense.form = { title: '', amount: 0, payer: 'æˆ‘', participants: [...people.value] };
            modals.value.expense.show = true;
        };

        const saveExpense = async () => {
            if(!userId.value) return;
            const id = crypto.randomUUID();
            await fb.setDoc(fb.doc(getExpenseColl(), id), { ...modals.value.expense.form });
            modals.value.expense.show = false;
        };

        const deleteExpenseItem = async id => { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) await fb.deleteDoc(fb.doc(getExpenseColl(), id)); };

        const totalExpense = computed(() => expenses.value.reduce((s, e) => s + (Number(e.amount) || 0), 0));
        const settleBalances = computed(() => {
            const b = {}; people.value.forEach(p => b[p] = 0);
            expenses.value.forEach(e => {
                const amount = Number(e.amount) || 0;
                const per = amount / e.participants.length;
                b[e.payer] += amount;
                e.participants.forEach(p => b[p] -= per);
            });
            return b;
        });

        return { 
            userId, loading, activeTab, itinerary, expenses, people, modals, 
            groupedItinerary, totalExpense, settleBalances, 
            openItineraryModal, saveItinerary, deleteItineraryItem, toggleItineraryDone, importDefaults,
            openExpenseModal, saveExpense, deleteExpenseItem 
        };
    }
}).mount('#app');
</script>
</body>
</html>
